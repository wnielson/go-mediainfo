# AGENTS

Owner: soup

## Scope
- Goal: 1:1 feature parity with MediaInfo CLI
- Pure Go implementation, no CGO
- Cross-platform

## Learnings / Decisions
- Command name: mediainfo
- Parity target: MediaInfo-master in this repo
- CLI option parsing: case-insensitive before "=" only; values preserve case
- Unknown --Option[=Value] forwarded to core (default value "1" if missing)
- Help text copied from upstream CLI (Help.cpp)
- Stub core: parsing not implemented yet
- Upstream C++ tree kept untracked via root .gitignore
- Post-parity target: MediaInfo issue #760 (DVD IFO language/runtime regression)
- Issue #760 notes: IFO in VIDEO_TS shows VOB-derived streams but loses audio language; same IFO copied elsewhere shows languages; BUP files show old IFO-style info
- Issue #760: dev snapshots fixed duration, language issue persists when IFO is inside VIDEO_TS; still reported broken in 23.07+
- `--output` without "=" treated as filename (matches upstream)
- `--` alone is a no-op (ignored)
- `--help` prints version line then usage
- Core analyzer implemented (General stream only): format sniff + file size
- Text output aligns with MediaInfo-style label/value columns
- JSON output implemented (minimal MediaInfo-like shape)
- MP4/MOV: parse `moov/mvhd` for duration; compute overall bitrate
- Matroska: parse Segment/Info for duration using TimecodeScale
- MPEG-TS: parse PAT/PMT, map stream types, PTS-based duration
- MPEG-PS: scan PES for stream types + PTS-based duration
- Text output now numbers stream groups (e.g., Audio #1)
- MP4: track detection via `trak/mdia/hdlr` (vide/soun/text)
- Matroska: track detection via Tracks/TrackEntry/TrackType
- MP4: sample entry parsing (`stsd`) for codec format
- Matroska: codec mapping via CodecID
- MP4: parse width/height (video) and channels/sampling rate (audio) from sample entry
- Matroska: parse track video/audio settings (pixel width/height, channels, sampling rate)
- MP4: derive frame rate from mdhd duration + stts sample count
- Matroska: derive frame rate from DefaultDuration
- General/stream fields now sorted to match MediaInfo ordering
- MPEG-TS: estimate frame rate from video PES count vs PTS span
- MPEG-TS/MPEG-PS: add video stream duration + bitrate (best-effort)
- MPEG-PS: per-stream IDs surfaced; JSON multi-file now outputs media list
- MPEG-PS: estimate frame rate from video PTS count vs duration
- Bit rate mode now emitted when bitrate is computed
- TS/PS: per-stream PTS tracking for non-video durations
- Stream common helper added for duration/bitrate fields
- JSON track ordering now stable; MP4/MKV audio durations added
- Channel layout now emitted for common channel counts
- JSON field ordering now matches CLI ordering
- JSON output now uses MediaInfoLib creatingLibrary + 26.01 version, with best-effort key mapping/values (still missing many raw fields)
- JSON output now matches MediaInfo CLI for MP4 (field order + formatting + raw values)
- MP4: top-level box sizes (ftyp/free/mdat/moov) mapped to JSON Header/Data/Footer/StreamSize + IsStreamable
- MP4: edit list media_time captured; JSON extra Source_Delay derived from media_time/timescale
- MP4 audio bitrate estimated from sample sizes + duration
- Matroska BitRate element parsed into stream Bit rate
- XML/HTML output renderers added (basic)
- JSON/XML/CSV outputs are not yet MediaInfo schema-compatible (currently text-like field names/values)
- --info-parameters / --info-canhandleurls now implemented (basic)
- Info-Parameters expanded to include IDs + menu group
- Output format placeholders accepted for CSV/EBUCore/PBCore/Graph
- CSV/EBUCore/PBCore renderers added (basic)
- Graph DOT/SVG outputs added (empty)
- CSV/XML/HTML now include stream numbering titles
- CSV output uses section headers (no header row), no CSV quoting, blank line between sections, 2 trailing blank lines
- AC-3 stats: text/CSV emit dialnorm_Maximum even when equal to Minimum; JSON extra only when distinct
- formatBytes for <1 KiB uses "Bytes" (not "B")
- XML field names sanitized for valid tags (spaces -> _)
- Upstream build needs autoconf/automake/libtool/pkg-config; use PATH "/opt/homebrew/opt/libtool/libexec/gnubin" for glibtoolize
- Built CLI binary at `~/github/oss/mediainfo-build/MediaInfo/Project/GNU/CLI/mediainfo`
- `--info-canhandleurls` prints libcurl-disabled message when built without libcurl
- Fixed file size units (KiB/MiB bug) + added formatBytes tests
- Added pure-Go parsers for MP3/FLAC/WAV/Ogg (duration/bitrate/channels/sample rate/bit depth)
- Audio-only general bitrate mode now set from parse (constant for PCM/CBR)
- MP4: parse `ftyp` for Format profile + Codec ID; `udta/meta/ilst/Â©too` for Writing application
- MP4: track IDs from `tkhd`, AAC profile from `esds`, bitrate from `btrt`
- MP4 AVC: parse `avcC` SPS/PPS for profile, chroma subsampling, bit depth, scan type, CABAC, ref frames, aspect ratio
- MP4: add stream size, bits/(pixel*frame), compression mode, frame rate mode, AAC frame rate
- MP4: honor edit list (`edts/elst`) for display duration, add Source duration + Source_Duration_LastFrame; stream size scales via sample delta
- Formatting: file size now rounds like MediaInfo; sub-minute durations show `X s Y ms`
- Matroska: parse EBML DocTypeVersion, SegmentUID, Writing/Muxing app; track number mapped to ID; add Format/Info
- Matroska: AVC codec private -> profile/settings/chroma/bit depth/scan; AAC ASC -> AAC LC + Codec ID A_AAC-2
- Matroska: tags ENCODER -> audio Writing library; x264 settings -> Nominal bit rate + Bits/(Pixel*Frame)
- Matroska: track flags Default/Forced; video color range; ErrorDetectionType defaulted to Per level 1
- MPEG-TS: overall duration/bitrate derived from PCR interval average (packets between PCRs) to match CLI
- MPEG-TS: handle PCR PID payload (don't skip PES when PCR PID == video PID)
- MPEG-TS: parse x264 writing library + encoding settings from video PES (Annex B), add Nominal bit rate
- MPEG-TS: audio ADTS parsing needs int-cast shifts + next-sync validation; duration uses integer ms floor
- Text output: label column width 41 + ends with 2 blank lines (Fprintln adds 1) to match CLI
- AVI: parse RIFF hdrl/strl/movi + INFO/ISFT; MPEG-4 Visual VOL/user data for profile/BVOP/QPel/GMC/Matrix; frame rate ratio for stream, simple rate for general
- MPEG-PS/VOB: parse PES + MPEG-2 sequence/extension/GOP/picture headers for profile/Matrix/GOP/timecode/BVOP; duration uses PTS span + 2 frames; stream bitrate uses floored kbps for CLI parity
- MPEG Video (MPG): detect elementary stream; parse MPEG-2 headers for profile/GOP/timecode; add extension warning fields and general Format version
- MPEG-PS: private stream 0xBD substream IDs map AC-3 (0x80-0x87) / RLE subs (0x20-0x3F); AC-3 payload skips 4-byte DVD header; parse AC-3 header for bitrate/channels/sample rate/service kind; AAC ADTS probing for PS audio
- MPEG-PS: pack/system/padding headers (0xBA/0xBB/0xBE) need explicit skip; PTS parsing now checks marker bits; NTSC/PAL standard only when 720x480/576
- MPEG-PS: private stream 2 (0xBF) carries DVD menu/navigation; no PES header, payload is length-only; emit Menu stream with Format "DVD-Video" (no ID)
- ADTS: ID bit drives AAC Format version (MPEG-2 -> Version 2, MPEG-4 -> Version 4); expose Codec ID from AAC audio object in PS
- MPEG-PS: detect AVC in PES via Annex B SPS/PPS, switch format to AVC, parse profile/ref frames/CABAC + width/height/framerate
- H.264 SPS: parse video_format for Standard (PAL/NTSC/SECAM/MAC) + full-range flag for Color range
- AAC in PS: duration from PTS span + 3 AAC frames (1024 samples) to match CLI
- MPEG-PS AVC: slice count from Annex B first_mb_in_slice; probe after buffer grows (avoid early 1-slice false positives)
- MPEG-TS: do not emit slice count (CLI sample output omits it)
- H.264 Annex B: require SPS+PPS, valid profile, width/height; skip NALs with forbidden_zero_bit to avoid false AVC detection
- MPEG-PS AAC delay: adjust by 3 video frames for AVC to match CLI delay output; format delay as signed duration
- Bitrate formatting: use Mb/s when >= 1,000,000 bps in `formatBitrate`
- MPEG-PS AC-3: buffer across PES payloads; use AC-3 frame size table + next-sync validation; parse dialog normalization/compr/cmixlev/surmixlev/mixlevel/roomtyp + dialnorm stats
- AC-3 `compr` dB uses heavy dynamic range scale `pow(2, v) * ((code & 0xF) | 0x10)` with `v = (code>>4) - ((code>>7)<<4) - 4`, then `20*log10(scale)`
- Matroska JSON parity: TrackUID -> `UniqueID`, TrackOffset -> `Delay`/`Video_Delay` (Container); video Duration uses frameCount*DefaultDuration with 9-decimal JSON
- Matroska JSON adds `colour_*` fields when Color range present; `ErrorDetectionType` lives under `extra`
- JSON Rotation should be injected for MP4 video only; AAC `FrameCount` only for `mp4a*` codec IDs
- MPEG-TS JSON parity: StreamOrder `0-0`/`0-1`, IDs/MenuID decimal-only; Duration/Delay 9-decimal JSON; precision min/max = overall/9600
- MPEG-TS Menu JSON: `List_StreamKind`/`List_StreamPos`, Service* fields, PMT `pointer_field` + `section_length` in `extra`
- MPEG-PS JSON: FirstPacketOrder ignores Menu streams (video/audio start at 0)
- MPEG-PS JSON: GOP-only header-byte bitrate uses small duration bias (0.99818) to match MediaInfo (sample_ac3.vob)
- AVI JSON: StreamSize uses raw bytes; BitRate uses stream rate/scale duration (not kb/s-rounded); General JSON carries OverallBitRate/FrameCount/StreamSize
- MPEG Video JSON: no StreamOrder; BitRate uses JSON-rounded Duration; Delay_Settings from GOP header; BufferSize + intra_dc_precision in `extra`
- JSON field order: Delay_Settings between Delay and Delay_DropFrame; Format_Settings only for General
- AC-3 JSON: ServiceKind uses short codes (e.g., CM)
- AC-3 stats parity: dialnorm/compr/dynrng averages are intensity-based; skip compr/dynrng code 0xFF; dynrng counts include dynrnge=false frames as 0 dB but stats only emitted when any dynrnge seen
- ParseSpeed default is 0.5; ParseSpeed>=1 enables full E-AC-3 probe, <1 limits compr stats sample (target 1113 frames)
- Matroska E-AC-3: parse laced frames per-frame for probe stats
- E-AC-3 compr field uses 0xFF mapping (ac3ComprDB(0xFF)) even when stats exclude 0xFF

## Notes
- Update this file as we learn more about CLI behavior, formats, and edge cases.
